
### Принципы разделения:

1. **Универсальное → `infra/`:**
   - Всё, что применимо к тестированию любого ПО (SSH, деплой, снапшоты, обновление ОС).

2. **Специфичное для ПО → `plugins/<имя_ПО>/`:**
   - Логика установки, настройки, специфичные проверки.

3. **Тесты:**
   - Универсальные тесты фреймворка → `tests/`.
   - Тесты конкретного ПО → `tests_<имя_ПО>/`.

## Инфраструктура и конфигурация

1. **ALT Linux, Proxmox, Git.**  
   Рабочая среда — ALT Linux, тесты выполняются в ВМ Proxmox. Проект и конфиги версионируются в Git.

2. **Два узла Proxmox:**
   - `r` — первый сервер Proxmox,  
   - `pve9` — второй сервер Proxmox.  
   Оба используются по очереди или выборочно; иногда доступен только один из них.

3. **Единый конфиг `config.yaml`.**
   - Хранит параметры узлов (`host`, `user`, `key_path`, `storage`),  
   - Параметры по умолчанию для деплоя (память, CPU и т.п.),  
   - Настройки логирования (уровень, цвета),
   - Секции для плагинов (`plugins:`), где хранятся специфичные параметры (пути к дистрибутивам, версии и т.п.).

4. **Приоритет источников настроек:**
   1. Аргументы командной строки (CLI);
   2. `config.yaml`.
   
   **Жёстко зашитые значения (хардкод) не используются.** Если параметр не передан через CLI и отсутствует в конфиге, программа должна явно сообщить об ошибке.

5. **Общий модуль конфигурации `infra/config.py`.**
   - Предоставляет функции:
     - `load_config()` — загрузка `config.yaml`;
     - `get_node_params(node_name, config=None)` — параметры конкретного узла.
   - Все части проекта (скрипты, тесты, плагины) должны использовать **только этот модуль**, а не читать YAML напрямую.

## Логи, вывод и стиль кода

1. **Логирование и цветной вывод.**
   - Использовать стандартный модуль `logging` и библиотеку `coloredlogs`.
   - Подробные информативные сообщения, без "тихих" магий.
   - Не спамить stacktrace там, где ошибка ожидаема (например, ожидание запуска guest‑agent).

2. **Комментарии в коде.**
   - Щедрые и понятные комментарии на русском.
   - Объяснять **почему** делается то или иное действие, а не только **что** оно делает.
   - Docstring'и у ключевых функций/модулей.

3. **Импорты и структура.**
   - Использовать модульный запуск: `python -m infra.deploy ...`, чтобы гарантировать корректную работу импортов.
   - Общая логика (работа с конфигом, SSH-утилиты) должна выноситься в отдельные модули вместо дублирования.

## Git workflow

1. **Частые маленькие коммиты.**
   - Один логический шаг → один коммит.
   - Коммиты должны быть атомарными и легко откатываемыми.

2. **Формат сообщений (Conventional Commits):**
   - `feat: ...` — новая функциональность;
   - `fix: ...` — исправление ошибки;
   - `refactor: ...` — рефакторинг без изменения поведения;
   - `docs: ...` — изменения документации;
   - `test: ...` — изменения в тестах;
   - `chore: ...` — рутинные изменения (конфиги, CI и т.п.).

3. **Напоминания о коммитах.**
   Ассистент:
   - после успешного шага предлагает сделать коммит,
   - предлагает осмысленное сообщение коммита,
   - при необходимости — советует использовать `git commit --amend` и объясняет, когда это уместно.

## TDD и модульность сценариев

Цель — иметь возможность **запустить тестирование КриптоПро с любого шага** (чекпоинта):  
от полностью "чистой" ВМ до уже установленного и частично протестированного КриптоПро.

### Снапшоты ВМ (Checkpoints)
**Важно:** После успешного прохождения каждого этапа тестирования/настройки необходимо создавать снапшот ВМ. Это позволяет:
- Откатываться к "чистому" состоянию этапа при ошибках.
- Стартовать тесты следующих этапов сразу с нужного состояния, пропуская долгие предыдущие шаги.

### Основные этапы (чекпоинты)

1. **Развёртывание тестовой ВМ:**
   - Используем `infra/deploy.py` и `config.yaml`.
   - ВМ развернута из выбранного снапшота, диски в tmpfs‑хранилище.
   - **Snapshot:** `fresh_deploy`

2. **Обновление ОС (первый шаг методики CryptoPro).**
   - Полное обновление пакетов (Ansible / shell).
   - Тесты проверяют: успешность обновления, корректность версии ядра/пакетов.
   - **Snapshot:** `os_updated`

3. **Копирование дистрибутива КриптоПро на ВМ.**
   - Тесты проверяют наличие нужных файлов на целевой машине, контрольные суммы и права.
   - **Snapshot:** `dist_copied`

4. **Установка КриптоПро.**
   - Шаги установки в соответствии с методикой.
   - Тесты проверяют: наличие бинарников, сервисов, записей в пакетах, корректность путей.
   - **Snapshot:** `cpro_installed`

5. **CLI‑тесты КриптоПро.**
   - Проверка работы `csptest`, `cpconfig` и других утилит.
   - Проверка лицензии, сертификатов, криптоопераций по методике.
   - (Опционально снапшоты после крупных блоков CLI тестов, если они меняют состояние).

6. **GUI‑тесты (позже).**
   - Отдельный уровень (Wayland/X11, pyautogui/SikuliX и т.п.).
   - Запуск в отдельном наборе тестов/маркировке.

### Правила модульности и перезапуска

1. **Каждый этап — набор тестов.**
   - Например:
     - `tests/test_os_update.py` — обновление ОС (универсальный);
     - `tests_cryptopro/test_cpro_copy_dist.py` — копирование дистрибутива;
     - `tests_cryptopro/test_cpro_install.py` — установка;
     - `tests_cryptopro/test_cpro_cli.py` — CLI‑проверки КриптоПро.

2. **Запуск с любого шага.**
   - Использовать pytest‑маркировку (`@pytest.mark.stage("os_update")`, `"install"`, `"cli"` и т.д.),  
     чтобы можно было запускать, например:
     - `pytest -m os_update`
     - `pytest -m cpro_install`
     - `pytest -m cpro_cli`
   - Либо структурировать по файлам/папкам с понятными именами.

3. **TDD для каждого этапа.**
   - Сначала формулировать, какие проверки нужны на этапе (осмысленные тесты),
   - затем добавлять/изменять код деплоя/скрипты/Ansible/плагины для прохождения этих тестов.

4. **Безопасность и идемпотентность.**
   - Скрипты деплоя (например, `infra/deploy.py`) должны быть идемпотентными:
     - обнаруживать уже существующие ВМ,
     - корректно удалять/пересоздавать их с флагом `--force` или интерактивным подтверждением,
     - не ломаться при отсутствии tmpfs‑дисков (ожидаемое состояние после перезагрузки).

## Использование этого файла в новых беседах

1. При старте новой беседы по `cpro-autotest`:
   - Указать ссылку на репо `pooow/cpro-autotest`;
   - Попросить ассистента прочитать `docs/AI_WORKFLOW.md` и следовать этим правилам.

2. При изменении процесса:
   - Сначала обновить этот файл (добавить/изменить правила),
   - затем упомянуть в беседе, что `AI_WORKFLOW.md` обновлён,
   - ассистент должен ориентироваться на **последнюю версию файла** в Git.

3. При противоречиях:
   - Если указания в промпте противоречат `AI_WORKFLOW.md`,
   - приоритет всегда за **AI_WORKFLOW.md** (если явно не сказано иначе).
