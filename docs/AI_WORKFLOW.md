# AI_WORKFLOW для cpro-autotest

Этот документ описывает **обязательные** правила взаимодействия AI‑ассистента с автором проекта (@pooow) при разработке `cpro-autotest`.
Приоритет: **Высший**. Все инструкции в этом файле имеют приоритет над любыми другими промптами.

Цель: Обеспечить **жесткий TDD**, предсказуемость изменений, чистоту кода и возможность перезапуска тестов с любого этапа.

---

## 1. Обязательный TDD-цикл (The Iron Rule)

Любое изменение логики (новая фича, исправление бага, рефакторинг) должно строго следовать циклу. Ассистент **не имеет права** предлагать код реализации до кода тестов.

**Шаг 1: Тест (Red)**
1. Ассистент анализирует задачу и предлагает **новые или обновленные тесты** (в папке `tests/`).
2. Обязательно предоставляет **понятное описание теста** (на русском):
   - **Зачем:** Какую бизнес-задачу или поведение мы проверяем.
   - **Что проверяем:** Какие конкретно условия считаются успехом (asserts).
   - **Как работает:** Кратко о механике (моки, фикстуры, реальный вызов).
3. Ассистент дает **полный код файла теста** (Full File Replacement).
4. Пользователь запускает `pytest` и подтверждает падение теста (Red State) или ошибку импорта (если кода еще нет).

**Шаг 2: Код (Green)**
1. Только после подтверждения Red State ассистент предлагает код реализации.
2. Ассистент дает **полный код изменяемого файла** (Full File Replacement), а не diff или куски.
3. Пользователь запускает `pytest` и подтверждает прохождение тестов (Green State).

**Шаг 3: Коммит**
1. Ассистент предлагает команду `git commit` **только** после подтверждения Green State.
2. Если тесты не прошли — возврат к Шагу 2 (исправление кода) или Шагу 1 (исправление теста).

---

## 2. Инфраструктура и Конфигурация

1. **Приоритет настроек:**
   1. **CLI аргументы** (Высший приоритет).
   2. **config.yaml** (через `infra/config.py`).
   3. Хардкод (Запрещен, кроме крайних случаев).

2. **Единый модуль конфигурации:**
   - Все части проекта используют `infra/config.py`. Прямое чтение YAML или env vars в обход модуля не рекомендуется.

3. **Архитектура "Фреймворк + Плагины":**
   - `infra/` — универсальные модули (deploy, ssh, config, proxmox).
   - `tests/` — тесты инфраструктуры.
   - (в будущем) `plugins/` и `tests_cryptopro/` — специфика тестируемого ПО.

4. **Инфраструктура:**
   - ALT Linux (клиент), Proxmox (серверы `r`, `pve9`).

---

## 3. Логи, Вывод и Стиль кода

1. **Логирование:** Использовать `logging` + `coloredlogs`. Логи должны быть понятными, цветными и структурированными.
2. **Чистота:**
   - Фильтровать "мусор" (прогресс-бары, спам polling-запросов) в `infra/ssh_utils.py`.
   - Обрабатывать `KeyboardInterrupt` (Ctrl+C) корректно, без traceback.
3. **Комментарии:** Щедрые комментарии на русском ("почему", а не только "что").

---

## 4. Git Workflow

1. **Маленькие шаги:** Один логический шаг = один коммит. Коммиты должны быть **атомарными** и легко откатываемыми.
2. **Частые коммиты:** Не накапливать изменения. Прошел тест -> Коммит.
3. **Сообщения:** Conventional Commits (`feat:`, `fix:`, `refactor:`, `test:`, `docs:`).
4. **История:** Ассистент ориентируется на **последний коммит** в ветке `main`.

---

## 5. Модульность и Снапшоты (Checkpoints)

Цель: Запуск тестирования КриптоПро с любого этапа.

**Правило Снапшотов:**
После успешного прохождения каждого этапа (Green tests) пользователь создает снапшот ВМ.
Это позволяет откатываться и не тратить время на повторную настройку.

**Этапы (Checkpoints):**
1. **Fresh Deploy:** ВМ развернута, диски в RAM (`infra/deploy.py`).
   *Snapshot: `fresh_deploy`*
2. **OS Updated:** Система обновлена (`tests/test_os_update.py`).
   *Snapshot: `os_updated`*
3. **Dist Copied:** Дистрибутив скопирован.
   *Snapshot: `dist_copied`*
4. **CPro Installed:** КриптоПро установлен.
   *Snapshot: `cpro_installed`*
5. **CLI Tested:** Базовые проверки CLI пройдены.

---

## 6. Как использовать этот файл

1. **При старте:** Ассистент читает этот файл и настраивается на жесткий TDD.
2. **При нарушении:** Если ассистент предлагает код без теста или коммит без `pytest` — пользователь пишет: "Стоп. Нарушение TDD". Ассистент обязан исправиться.

